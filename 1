import discord
from discord.ext import commands, tasks
import os, time, requests

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="!", intents=intents)

# ====== CONFIG ======
REACTION_MESSAGE_ID = 123456789012345678  # √§ndra
REACTION_ROLES = {
    "üî•": "Gamer",
    "üéÆ": "Player"
}

vc_times = {}

# ====== READY ======
@bot.event
async def on_ready():
    print(f"‚úÖ Inloggad som {bot.user}")
    twitch_live.start()

# ====== PING ======
@bot.command()
async def ping(ctx):
    await ctx.send(f"üèì Pong {round(bot.latency * 1000)}ms")

# ====== WELCOME + AUTOROLE ======
@bot.event
async def on_member_join(member):
    role = discord.utils.get(member.guild.roles, name="Member")
    if role:
        await member.add_roles(role)

    channel = discord.utils.get(member.guild.text_channels, name="welcome")
    if channel:
        await channel.send(f"üëã V√§lkommen {member.mention}!")

# ====== POLL ======
@bot.command()
async def poll(ctx, fr√•ga, *alternativ):
    emojis = ["1Ô∏è‚É£","2Ô∏è‚É£","3Ô∏è‚É£","4Ô∏è‚É£","5Ô∏è‚É£"]
    text = "\n".join(f"{emojis[i]} {alt}" for i, alt in enumerate(alternativ))
    msg = await ctx.send(f"üìä **{fr√•ga}**\n{text}")
    for i in range(len(alternativ)):
        await msg.add_reaction(emojis[i])

# ====== REACTION ROLES ======
@bot.event
async def on_raw_reaction_add(payload):
    if payload.message_id != REACTION_MESSAGE_ID:
        return

    guild = bot.get_guild(payload.guild_id)
    role_name = REACTION_ROLES.get(str(payload.emoji))
    if not role_name:
        return

    role = discord.utils.get(guild.roles, name=role_name)
    member = guild.get_member(payload.user_id)
    if role and member:
        await member.add_roles(role)

@bot.event
async def on_raw_reaction_remove(payload):
    if payload.message_id != REACTION_MESSAGE_ID:
        return

    guild = bot.get_guild(payload.guild_id)
    role_name = REACTION_ROLES.get(str(payload.emoji))
    role = discord.utils.get(guild.roles, name=role_name)
    member = guild.get_member(payload.user_id)
    if role and member:
        await member.remove_roles(role)

# ====== TEMP VC + VC STATS ======
@bot.event
async def on_voice_state_update(member, before, after):
    if after.channel and not before.channel:
        vc_times[member.id] = time.time()

        if after.channel.name == "‚ûï Skapa VC":
            vc = await after.channel.category.create_voice_channel(
                f"{member.name}s VC"
            )
            await member.move_to(vc)

    if before.channel and not after.channel:
        start = vc_times.pop(member.id, None)
        if start:
            mins = int((time.time() - start) / 60)
            print(f"{member.name} VC tid: {mins} min")

# ====== TWITCH LIVE PING ======
@tasks.loop(minutes=2)
async def twitch_live():
    headers = {
        "Client-ID": os.getenv("TWITCH_CLIENT_ID"),
        "Authorization": f"Bearer {os.getenv('TWITCH_TOKEN')}"
    }

    url = f"https://api.twitch.tv/helix/streams?user_login={os.getenv('TWITCH_CHANNEL')}"
    r = requests.get(url, headers=headers).json()

    if r.get("data"):
        guild = bot.guilds[0]
        role = discord.utils.get(guild.roles, name=os.getenv("LIVE_ROLE"))
        channel = discord.utils.get(guild.text_channels, name=os.getenv("LIVE_CHANNEL"))
        if role and channel:
            await channel.send(f"üî¥ {role.mention} **STREAMEN √ÑR LIVE!**")

# ====== RUN ======
bot.run(os.getenv("TOKEN"))
